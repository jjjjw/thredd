var coll = require('./collections/comments')
  , schema = require('./schemas/comment')
  , validateAndSave = require('./helpers').validateAndSave
  ;

exports.get = function (query) {
  return coll.find(query);
};

exports.getThread = function (article) {
  return coll.find({ article: article.id }).then(function (comments) {
    return exports.threadify(comments);
  });
};

exports.post = function (comment) {
  comment.createdAt = new Date().getTime();
  return validateAndSave(comment, schema, coll);
};

exports.threadify = function (commentList) {
  var topLevel = [];
  if (!commentList || !commentList.length) return topLevel;
  commentList = commentList.sort(function(a, b) {
    return a.createdAt - b.createdAt;
  });
  var parentMap = {};
  commentList.forEach(function (comment) {
    parentMap[comment.id] = comment;
    var parent = parentMap[comment.parent];
    if (!parent) {
      topLevel.push(comment);
      return;
    }
    if (!parent.children) parent.children = [];
    parent.children.push(comment);
  });
  return topLevel;
};
