var React = require('react');

module.exports = React.createClass({
  componentDidMount: function () {
    if (this.props.parent) {
      this.refs.editor.getDOMNode().focus();
    }
  }
  , getInitialState: function () {
    return {error: '', text: ''};
  }
  , onChange: function (e) {
    this.setState({text: e.target.value});
  }
  , onKeyDown: function (e) {
    if ((e.ctrlKey || e.metaKey) && e.keyCode == 13) {
      this.handleSubmit(e);
    }
  }
  , onSuccess: function () {
    if (this.props.hide) {
      this.props.hide();
      return;
    }
    this.refs.editor.getDOMNode().blur();
  }
  , onErr: function (err) {
    this.setState({error: 'There was an error'});
    setTimeout(function () {
      this.setState({error: ''});
    }.bind(this), 5000);
  }
  , handleSubmit: function (e) {
    e && e.preventDefault();
    if (!this.state.text) {
      return;
    }
    var ev = new CustomEvent('commentEntered', {
      bubbles: true
      , detail: {
        body: this.state.text
        , onErr: this.onErr
        , onSuccess: this.onSuccess
        , parent: this.props.parent
      }
    });
    this.getDOMNode().dispatchEvent(ev);
    this.setState({text: ''});
  }
  , render: function () {
    return React.DOM.div({className: 'editor'}
      , React.DOM.form({onSubmit: this.handleSubmit}
        , React.DOM.textarea({
          className: 'editor'
          , onChange: this.onChange
          , onKeyDown: this.onKeyDown
          , ref: 'editor'
          , value: this.state.text
          , placeholder: 'Add your comment'
        })
        , React.DOM.div({className: 'editor-actions'}
          , React.DOM.button({className: 'post'}, 'Post')
          , React.DOM.span({className: 'error-msg'}, this.state.error)
        )
      )
    );
  }
});
