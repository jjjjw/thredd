var Editor = require('ui/editor')
  , keyById = require('transforms').keyById
  , fs = require('fs')
  , getArticleData = require('./helpers').getArticleData
  , Mustache = require('mustache')
  , React = require('react')
  , Thread = require('ui/thread').Thread
  , threadify = require('transforms').threadify
  ;

var articleTemplate = fs.readFileSync(__dirname + '/templates/article.mustache').toString();

module.exports = function (id) {
  return getArticleData(id)
  .then(function (data) {
    var article = data.article
      , comments = data.comments
      , users = data.users
      ;

    var commentsHtml = React.renderComponentToString(Thread({
      comments: threadify(comments)
      , depth: 0
      , users: keyById(users)
    }))
    , editorHtml = React.renderComponentToString(Editor())
    , initJSON = JSON.stringify({
      article: article.id
      , comments: comments
      , users: users
    })
    ;

    return Mustache.render(articleTemplate, {
      body: article.body
      , editor: editorHtml
      , comments: commentsHtml
      , initJSON: initJSON
      , title: article.title
    });
  });
};
