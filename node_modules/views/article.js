var Comments = require('./templates/comments')
  , Editor = require('ui/editor')
  , React = require('react/addons')
  , getArticleData = require('./helpers').getArticleData
  , Showdown = require('showdown')
  ;

var converter = new Showdown.converter();

module.exports = function (id) {
  return getArticleData(id)
  .then(function (data) {
    var article = data.article
      , comments = data.comments
      , users = data.users
      ;

    comments.forEach(function (comment) {
      comment.body = converter.makeHtml(comment.body);
    });

    comments.sort(function (a, b) {
      return b.createdAt - a.createdAt;
    });

    var commentsHtml = Comments(comments, users)
    , editorHtml = React.renderComponentToString(Editor())
    , initJSON = JSON.stringify({
      article: article.id
      , comments: comments
      , users: users
    })
    ;

    return {
      body: article.body
      , editor: editorHtml
      , comments: commentsHtml
      , initJSON: initJSON
      , title: article.title
    };
  });
};
