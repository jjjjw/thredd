var Commentor = require('ui/commentor')
  , fs = require('fs')
  , Mustache = require('mustache')
  , transforms = require('services/transforms')
  , React = require('react')
  , Thread = require('ui/thread').Thread
  ;

// use Collection: demoArticle540ccc78c3e00723f02ed997
var articleTemplate = fs.readFileSync(__dirname + '/templates/article.mustache').toString();

module.exports = function (data) {
  var article = data.article
    , comments = data.comments
    , users = data.users
    ;

  var commentsHtml = React.renderComponentToString(Thread({
    comments: transforms.threadify(comments)
    , depth: 0
    , users: transforms.keyById(users)
  }))
  , commentorHtml = React.renderComponentToString(Commentor())
  , initJSON = JSON.stringify({
    article: article.id
    , comments: comments
    , users: users
  })
  ;

  return Mustache.render(articleTemplate, {
    body: article.body
    , commentor: commentorHtml
    , comments: commentsHtml
    , initJSON: initJSON
    , title: article.title
  });
};
