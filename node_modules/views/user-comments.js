var commentsSvc = require('services/comments')
  , Comment = require('ui/thread').Comment
  , fs = require('fs')
  , keyById = require('transforms').keyById
  , Mustache = require('mustache')
  , React = require('react')
  , usersSvc = require('services/users')
  ;

var tmpl = fs.readFileSync(__dirname + '/templates/user-comments.mustache').toString();

module.exports = function (id) {
  var users;
  return usersSvc.get(id)
  .then(function(results) {
    if (!results.length) {
      var err = new Error('No user found');
      err.status = 404;
      throw err;
      return;
    }
    users = results;
    return commentsSvc.getForUsers(id)
  })
  .then(function (comments) {
    var commentsHtml = '';
    var user = users[0];
    users = keyById(users);
    comments.forEach(function (comment) {
      commentsHtml += React.renderComponentToStaticMarkup(Comment({
        comment: comment
        , depth: 0
        , users: users
      }));
    });

    return Mustache.render(tmpl, {
      commentsHtml: commentsHtml
      , user: user
    });
  });
};
