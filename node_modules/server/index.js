var articleView = require('views/article')
  , getArticleData = require('./helpers').getArticleData
  , koa = require('koa')
  , parse = require('co-body')
  , route = require('koa-route')
  , serve = require('koa-static')
  ;

var app = module.exports = koa();

app.use(serve('./public'));

app.use(route.get('/articles/:id', function *(id) {
  var response = this.response;
  this.body = yield getArticleData(id)
  .then(function (data) {
    return articleView(data);
  }, function (err) {
    if (err === '404') {
      response.status = 404;
      return 'No bacon';
    }
    throw err;
  });
}));

app.use(route.post('/comments', function *() {
  this.body = yield parse.json(this).then(comments.post);
}));

if (!module.parent) {
  app.listen(parseInt(process.env.PORT, 10));
  console.log('listening on port ' + process.env.PORT);
}
