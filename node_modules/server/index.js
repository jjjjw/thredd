var articleView = require('views/article')
  , articlesView = require('views/articles')
  , comments = require('services/comments')
  , fs = require('fs')
  , koa = require('koa')
  , parse = require('co-body')
  , route = require('koa-route')
  , serve = require('koa-static')
  , url = require('url')
  , userCommentsView = require('views/user-comments')
  ;

var app = module.exports = koa();

app.use(serve('./public'));

app.use(route.get('/', function *() {
  this.response.redirect('/articles');
}));

app.use(route.get('/articles/:id', function *(id) {
  this.body = yield articleView(id);
}));

app.use(route.get('/articles', function *() {
  this.body = yield articlesView();
}));

app.use(route.post('/comments', function *() {
  var comment = yield parse.json(this);
  this.body = yield comments.post(comment);
}));

app.use(route.get('/users/:id', function *(id) {
  this.response.redirect('/users/' + id + '/comments');
}));

app.use(route.get('/users/:id/comments', function *(id) {
  this.body = yield userCommentsView(id);
}));

if (!module.parent) {
  app.listen(parseInt(process.env.PORT, 10));
  console.log('listening on port ' + process.env.PORT);
}
