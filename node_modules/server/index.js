var article = require('views/article')
  , articles = require('views/articles')
  , comments = require('services/comments')
  , fs = require('fs')
  , koa = require('koa')
  , logger = require('koa-logger')
  , parse = require('co-body')
  , route = require('koa-route')
  , serve = require('koa-static')
  , url = require('url')
  , userComments = require('views/user-comments')
  , views = require('co-views')
  ;

var app = module.exports = koa();

if (process.env.NODE_ENV === 'development') {
  app.use(logger());
}

app.use(serve('./public'));

var render = views('node_modules/views/templates', {
  map: { mustache: 'mustache' }
});

app.use(route.get('/', function *() {
  this.response.redirect('/articles');
}));

app.use(route.get('/articles/:id', function *(id) {
  var data = yield article(id);
  this.body = yield render('article.mustache', data);
}));

app.use(route.get('/articles', function *() {
  var data = yield articles();
  this.body = yield render('articles.mustache', data);
}));

app.use(route.post('/comments', function *() {
  var comment = yield parse.json(this);
  this.body = yield comments.post(comment);
}));

app.use(route.get('/users/:id', function *(id) {
  this.response.redirect('/users/' + id + '/comments');
}));

app.use(route.get('/users/:id/comments', function *(id) {
  var data = yield userComments(id);
  this.body = yield render('user-comments.mustache', data);
}));

if (!module.parent) {
  app.listen(parseInt(process.env.PORT, 10));
  console.log('listening on port ' + process.env.PORT);
}
