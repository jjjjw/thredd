var commentsEl = document.getElementById('js-comments-container')
  , dataEl = document.getElementById('js-data-msg')
  , request = require('superagent')
  ;

function noop () {};

function storeUpdated (article, comments, users) {
  var ev = new CustomEvent('storeUpdated', {
    detail: {
      article: article
      , comments: comments
      , users: users
    }
  });

  dataEl.dispatchEvent(ev);
}

module.exports = function (article, comments, users) {
  commentsEl.addEventListener('commentEntered', function (ev) {
    var detail = ev.detail;
    var onErr = detail.onErr || noop; // TODO: actual err handler
    var onSuccess = detail.onSuccess || noop;
    var comment = {
      article: article
      , body: detail.body
      , parent: detail.parent
      , user: '54111be98ca49e6f95b202c2' // TODO: user login
    };

    request
    .post('/comments')
    .send(comment)
    .end(function (err, res) {
      if (err) {
        onErr(err);
        return;
      }
      var resComment = res.body[0];
      resComment && comments.push(resComment);
      storeUpdated(article, comments, users)
      onSuccess();
    });
  });
};
