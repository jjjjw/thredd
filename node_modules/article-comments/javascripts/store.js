var request = require('superagent')
  , transforms = require('services/transforms')
  ;

function worldUpdated (article, comments, users) {
  var dataEl = document.getElementById('js-data-msg')
  var ev = new CustomEvent('storeUpdated', {
    detail: {
      article: article
      , comments: comments
      , users: users
    }
  });

  dataEl.dispatchEvent(ev);
}

module.exports = function (article, comments, users) {
  var commentsEl = document.getElementById('js-comments-container');

  commentsEl.addEventListener('commentEntered', function (ev) {
    var detail = ev.detail;
    var comment = {
      article: article
      , body: detail.body
      , parent: detail.parent
      , user: '54111be98ca49e6f95b202c2' // TODO
    };

    var optimisticComment = transforms.cloneShallow(comment);
    optimisticComment.createdAt = new Date().getTime();
    optimisticComment.id = optimisticComment.createdAt + '';

    comments.push(optimisticComment);
    worldUpdated(article, comments, users)

    request
      .post('/comments')
      .send(comment)
      .end(function (err, res) {
        if (err) {
          // TODO: err msg for user
          console.log(err);
          return;
        }
        var resComment = res.body[0];
        comments.some(function (next) {
          if (next.id !== optimisticComment.id) return false;
          next.id = resComment.id;
          next.createdAt = resComment.createdAt;
          return true;
        });
        worldUpdated(article, comments, users);
      });
  });
};

