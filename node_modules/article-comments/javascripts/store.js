var cloneShallow = require('transforms').cloneShallow
  , copyShallow =  require('transforms').copyShallow
  , request = require('superagent')
  ;

function storeUpdated (article, comments, users) {
  var dataEl = document.getElementById('js-data-msg')
  var ev = new CustomEvent('storeUpdated', {
    detail: {
      article: article
      , comments: comments
      , users: users
    }
  });

  dataEl.dispatchEvent(ev);
}

module.exports = function (article, comments, users) {
  var commentsEl = document.getElementById('js-comments-container');

  commentsEl.addEventListener('commentEntered', function (ev) {
    var detail = ev.detail;
    var comment = {
      article: article
      , body: detail.body
      , parent: detail.parent
      , user: '54111be98ca49e6f95b202c2' // TODO: users
    };

    var optimisticComment = cloneShallow(comment);
    optimisticComment.createdAt = new Date().getTime();
    optimisticComment.id = optimisticComment.createdAt + '';

    comments.push(optimisticComment);
    storeUpdated(article, comments, users)

    request
    .post('/comments')
    .send(comment)
    .end(function (err, res) {
      if (err) {
        // TODO: err msg for user
        console.log(err);
        return;
      }
      var resComment = res.body[0];
      // sync attrs
      copyShallow(resComment, optimisticComment);
    });
  });
};
