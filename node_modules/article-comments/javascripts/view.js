var articleBodyEl = document.getElementById('article-body')
  , Comments = require('ui/comments')
  , commentsEl = document.getElementById('js-comments-container')
  , Editor = require('ui/editor')
  , editorEl = document.getElementById('js-editor-container')
  , keyById = require('transforms').keyById
  , React = require('react')
  ;

var quoteRe = /@"(.+)"/;
var quoteId = 0;

function createLink (quote, body) {
  return body.replace(quote, '<span id="quote-' + quoteId +'">' + quote + '</span>');;
}

// fucking hack
function processQuotes (comments) {
  var body = articleBodyEl.innerHTML;
  comments.forEach(function (comment) {
    var quote;
    var match = quoteRe.exec(comment.body);
    if (match && match.length > 1) {
      quote = match[1];
      body = createLink(quote, body)
      comment.body = comment.body.replace(match[0], '<a href="#quote-' + quoteId +'">"' + quote + '"</span>');
      quoteId++;
    }
  });

  articleBodyEl.innerHTML = body;
}

exports.render = function (article, comments, users) {
  var editorComponent = Editor()
    , commentsComponent = Comments({
      comments: comments
      , users: keyById(users)
    })
    ;

  // totes ugly
  processQuotes(comments);

  React.renderComponent(editorComponent, editorEl);
  React.renderComponent(commentsComponent, commentsEl);
};
